
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code 2 HTML Formatter</title>
    <style>
        html, body {
            height: 100%;
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            .toolbar select {
                margin-right: 12px;
                padding: 6px 8px;
                border-radius: 4px;
                border: 1px solid rgba(255,255,255,0.08);
                background: #2b2b2b;
                color: #fff;
                font-size: 14px;
            }
            .toolbar-left, .toolbar-right {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .toolbar-center {
                flex: 1 1 auto;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            #buymeacoffee {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            #buymeacoffee img {
                display: block;
                height: auto;
                width: auto;
                max-height: 100%;
            }
        }
        .toolbar {
            display: flex;
            align-items: center;
            background: #222;
            color: #fff;
            padding: 10px 20px;
            flex: 0 0 auto;
        }
        .toolbar button {
            margin-right: 20px;
            padding: 8px 16px;
            background: #41b9fe;
            color: #000;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
        }

        /* Hover effect specifically for the Format button: keep color/shadow but no movement */
        #formatBtn:hover {
            box-shadow: 0 8px 20px rgba(0,0,0,0.18);
            background: #2fa6e6;
            transform: none;
        }
        .toolbar label {
            margin-right: 15px;
            font-size: 15px;
            cursor: pointer;
        }
        .container {
            display: flex;
            flex: 1 1 auto;
            width: 100%;
            min-height: 0;
        }
        .editor-pane,
        .preview-pane {
            background: #fff;
            box-sizing: border-box;
            overflow: auto;
            min-width: 200px;
            min-height: 0;
            height: 100%;
        }
        .editor-pane {
            display: flex;
            flex-direction: column;
            flex: 0 0 50%;
            border-right: 1px solid #ddd;
        }
        .preview-pane {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            padding: 4px 20px 20px;
            overflow-wrap: anywhere;
            word-break: break-word;
            position: relative;
            overflow: visible;
        }
        .preview-pane:focus-within {
            outline: none;
        }
        #preview:focus {
            outline: none;
        }
        .resizer {
            width: 6px;
            cursor: col-resize;
            background: #848383;
            transition: background 0.2s ease;
            touch-action: none;
        }
        .resizer:hover,
        .resizer.dragging {
            background: #c0c0c0;
        }
        .rich-editor {
            width: 100%;
            flex: 1 1 auto;
            border: none;
            border-radius: 0;
            padding: 16px;
            background: #fff;
            font-size: 16px;
            outline: none;
            color: #222;
            font-family: monospace;
            /* No syntax highlighting or color styling */
            box-sizing: border-box;
            margin: 0;
            overflow: auto;
            min-height: 0;
        }
        #preview {
            flex: 1 1 auto;
            min-height: 0;
            overflow: auto;
        }
        .copy-icon {
            margin-left: auto;
            margin-right: 0;
            border: none;
            background: rgba(0,0,0,0.1);
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: background 0.2s ease;
        }
        .copy-icon:hover {
            background: #1a73e8;
        }
        .copy-icon img {
            width: 18px;
            height: 18px;
            display: block;
            transition: filter 0.2s ease;
        }
        .copy-icon:hover img {
            filter: brightness(0) invert(1);
        }
        .copy-icon[data-copied="true"]::after {
            content: 'Copied!';
            position: absolute;
            top: 50%;
            right: calc(100% + 8px);
            transform: translateY(-50%);
            background: rgba(0,0,0,0.85);
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            animation: copyFade 1.3s ease forwards;
            pointer-events: none;
        }

        @keyframes copyFade {
            0% { opacity: 0; transform: translate(-6px, -50%); }
            10% { opacity: 1; transform: translate(0, -50%); }
            80% { opacity: 1; transform: translate(0, -50%); }
            100% { opacity: 0; transform: translate(6px, -50%); }
        }

        /* Responsive / mobile styles */
        @media (max-width: 900px) {
            /* Use a small grid so we can place buyme beside the checkboxes on the first row
               and keep the copy icon on a separate second row */
            .toolbar {
                display: grid;
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                align-items: center;
                gap: 8px;
                padding: 10px;
            }
            /* Left controls (format, checkboxes, etc.) sit in the first row and span full width
               so the copy icon can live at the end of the control group but align to the right */
            .toolbar-left {
                grid-column: 1 / -1;
                grid-row: 1;
                display: flex;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }
            /* Put BuyMe in the first row, right column so it sits next to the checkboxes */
            .toolbar-center {
                grid-column: 2;
                grid-row: 1;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 8px;
            }
            /* Place copy icon in the right column of the first row so it stays right-aligned */
            .toolbar-right {
                grid-column: 2;
                grid-row: 1;
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 8px;
            }
            .container {
                flex-direction: column;
            }
            .editor-pane, .preview-pane {
                flex: none;
                width: 100%;
                min-height: 220px;
            }
            /* When stacked on mobile, remove editor right/bottom border and use preview top border */
            .editor-pane {
                border-right: none;
                border-bottom: none;
            }
            .preview-pane {
                border-top: 1px solid rgba(0,0,0,0.06);
            }
            /* Ensure no extra margin/gap between stacked panes */
            .editor-pane, .preview-pane { margin: 0; }
            .resizer {
                display: none;
            }
            .rich-editor {
                padding: 12px;
                font-size: 15px;
            }
            .preview-pane {
                padding: 8px 12px 16px;
            }
            .copy-icon {
                margin-left: auto;
                align-self: center;
            }
            #buymeacoffee img { height: 28px !important; }
        }

        /* Small phone adjustments */
        @media (max-width: 420px) {
            .toolbar-left button, .toolbar-left select, .toolbar-right .copy-icon {
                padding: 8px 10px;
                font-size: 14px;
            }
            .toolbar-left label {
                font-size: 13px;
            }
            .rich-editor { font-size: 14px; }
            .preview-pane { padding: 6px 8px 12px; }
        }
        .placeholder-text {
            color: #999;
        }
        /* Global dark-mode class for editor & preview pane */
        .app-dark .rich-editor {
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .app-dark .rich-editor.placeholder-text {
            color: #a9a9a9;
        }
        .app-dark .preview-pane {
            background: #0f1114;
        }
        .app-dark .toolbar {
            background: #121317;
            color: #ddd;
        }
        .app-dark .toolbar button {
            background: #2a8fc8;
            color: #fff;
        }
        /* Desktop: ensure the copy icon is pinned to the far right of the toolbar */
        @media (min-width: 901px) {
            .toolbar {
                position: relative;
            }
            .copy-icon {
                position: absolute;
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="toolbar-left">
           
            <button id="formatBtn">CODE 2 HTML</button>
             <select id="languageSelect" aria-label="Language">
                <option value="javascript">Javascript</option>
            </select>
            <label><input type="checkbox" id="imgPreview"> Image Preview</label>
            <label><input type="checkbox" id="consoleToggle"> Console</label>
            <label><input type="checkbox" id="filenameToggle" checked> Header</label>
            <label><input type="checkbox" id="darkModeToggle" checked> Dark Mode</label>
            <div id="buymeacoffee">
                <a href="https://www.buymeacoffee.com/ZebuGames"><img src="https://img.buymeacoffee.com/button-api/?text=Buy me a coffee&emoji=&slug=ZebuGames&button_colour=FFDD00&font_colour=000000&font_family=Cookie&outline_colour=000000&coffee_colour=ffffff" alt="Buy me a coffee"/></a>
            </div>
            <div id="copyIcon" class="copy-icon" role="button" tabindex="0" aria-label="Copy preview HTML">
                <img src="images/copy.png" alt="Copy">
            </div>
        </div>
        <div class="toolbar-center">
        </div>
        <div class="toolbar-right">
        </div>
    </div>
    <div class="container" id="layoutContainer">
        <div class="editor-pane" id="editorPane">
            <div id="editor" class="rich-editor placeholder-text" contenteditable="true" spellcheck="false">
// Paste your code here
            </div>
        </div>
        <div class="resizer" id="resizer" aria-hidden="true"></div>
        <div class="preview-pane" id="previewPane">
            <div id="preview" contenteditable="true" spellcheck="false"></div>
        </div>
    </div>
    <script>
        const editor = document.getElementById('editor');
                // Remove color and background-color styles from pasted content
                editor.addEventListener('paste', function(e) {
                    e.preventDefault();
                    let text = '';
                    if (e.clipboardData) {
                        // Try to get plain text
                        text = e.clipboardData.getData('text/plain');
                    } else if (window.clipboardData) {
                        text = window.clipboardData.getData('Text');
                    }
                    // Insert as plain text, stripping all formatting
                    document.execCommand('insertText', false, text);
                });
        const preview = document.getElementById('preview');
        const formatBtn = document.getElementById('formatBtn');
        const imgPreview = document.getElementById('imgPreview');
        const consoleToggle = document.getElementById('consoleToggle');
        const filenameToggle = document.getElementById('filenameToggle');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const consoleOutput = document.getElementById('console');
        const layoutContainer = document.getElementById('layoutContainer');
        const editorPane = document.getElementById('editorPane');
        const previewPane = document.getElementById('previewPane');
        const resizer = document.getElementById('resizer');
        const copyIcon = document.getElementById('copyIcon');
        const languageSelect = document.getElementById('languageSelect');
        const buyMeImg = document.querySelector('#buymeacoffee img');
        const htmlSanitizer = document.createElement('div');

        const MIN_PANE_WIDTH = 200;
        let isDraggingDivider = false;

        function setPaneWidth(clientX) {
            const containerRect = layoutContainer.getBoundingClientRect();
            let newWidth = clientX - containerRect.left;
            const maxWidth = containerRect.width - MIN_PANE_WIDTH;
            newWidth = Math.max(MIN_PANE_WIDTH, Math.min(maxWidth, newWidth));
            const percentage = (newWidth / containerRect.width) * 100;
            editorPane.style.flex = `0 0 ${percentage}%`;
            previewPane.style.flex = '1 1 auto';
        }

        if (resizer) {
            resizer.addEventListener('pointerdown', (event) => {
                isDraggingDivider = true;
                resizer.classList.add('dragging');
                resizer.setPointerCapture(event.pointerId);
            });

            resizer.addEventListener('pointermove', (event) => {
                if (!isDraggingDivider) return;
                setPaneWidth(event.clientX);
            });

            const stopDragging = (event) => {
                if (!isDraggingDivider) return;
                isDraggingDivider = false;
                resizer.classList.remove('dragging');
                if (event.pointerId !== undefined && resizer.hasPointerCapture(event.pointerId)) {
                    resizer.releasePointerCapture(event.pointerId);
                }
            };

            resizer.addEventListener('pointerup', stopDragging);
            resizer.addEventListener('pointercancel', stopDragging);
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // No highlightJS for the editor itself; only used for preview formatting
        function highlightJS(code, colors) {
            const palette = colors || getThemeStyles().syntax;
            const structureKeywords = new Set(['for','while','switch','case','break','continue','return','if','else','do','try','catch','finally','throw','default']);
            const declarationKeywords = new Set(['let','const','var','function','class','extends','import','export','from','as','new','this','super','typeof','instanceof','delete','in','of','await','yield']);
            const reservedKeywords = new Set([...structureKeywords, ...declarationKeywords, 'async']);
            const literalBracketLeadChars = new Set(['=','(','[','{',':',',']);

            const placeholders = [];
            const PLACEHOLDER_PREFIX = '__PLACEHOLDER__';

            function stash(value) {
                const id = PLACEHOLDER_PREFIX + placeholders.length + '__';
                placeholders.push(value);
                return id;
            }

            function restoreFromIndex(text, startIndex) {
                const pattern = new RegExp(`${PLACEHOLDER_PREFIX}(\\d+)__`, 'g');
                return text.replace(pattern, (match, idx) => {
                    const index = Number(idx);
                    if (index >= startIndex) {
                        return placeholders[index];
                    }
                    return match;
                });
            }

            function protectSpans(text) {
                const startIndex = placeholders.length;
                const stripped = text.replace(/<span[^>]*>.*?<\/span>/g, match => stash(match));
                return { text: stripped, startIndex };
            }

            function colorParams(segment) {
                return segment.replace(/([a-zA-Z_$][\w$]*)/g, token => {
                    if (reservedKeywords.has(token) || token.startsWith(PLACEHOLDER_PREFIX)) {
                        return token;
                    }
                    return `<span style="color:${palette.param};">${token}</span>`;
                });
            }

            function isArrayLiteralContext(str, index) {
                let j = index - 1;
                while (j >= 0 && /\s/.test(str[j])) j--;
                if (j < 0) {
                    return true;
                }

                let char = str[j];

                if (char === '>') {
                    let k = j - 1;
                    while (k >= 0 && /\s/.test(str[k])) k--;
                    if (k >= 0 && str[k] === '=') {
                        return true; // arrow function => [
                    }
                }

                if (char === '?') {
                    let k = j - 1;
                    while (k >= 0 && /\s/.test(str[k])) k--;
                    if (k >= 0 && str[k] === '.') {
                        return false; // optional chaining obj?.[0]
                    }
                    return true; // ternary or nullish coalescing
                }

                if (literalBracketLeadChars.has(char)) {
                    return true;
                }

                if (/[a-zA-Z0-9_$]/.test(char)) {
                    let end = j;
                    while (j >= 0 && /[a-zA-Z0-9_$]/.test(str[j])) j--;
                    const word = str.slice(j + 1, end + 1);
                    if (reservedKeywords.has(word)) {
                        return true;
                    }
                    if (word.startsWith(PLACEHOLDER_PREFIX)) {
                        return false;
                    }
                    return false;
                }

                return false;
            }

            // Preserve strings and comments before other replacements
            code = code.replace(/(`(?:\\.|[^`])*`|"(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*')/g, match => stash(`<span style="color:${palette.string};">${escapeHtml(match)}</span>`));
            code = code.replace(/(\/\/[^\n]*|\/\*[\s\S]*?\*\/)/g, match => stash(`<span style="color:${palette.comment};">${escapeHtml(match)}</span>`));

            // Function declarations (async optional, name optional)
            code = code.replace(/((?:async\s+)?function)(\s*)([a-zA-Z_$][\w$]*)?(\s*\()([^)]*)(\))/g, (match, fnKeyword, space, name, openParen, params, closeParen) => {
                let result = fnKeyword + space;
                if (name) {
                    result += `<span style="color:${palette.functionDeclaration};">${name}</span>`;
                }
                result += openParen + colorParams(params) + closeParen;
                return result;
            });

            // Arrow functions with parenthesized parameters
            code = code.replace(/(\()([^)]*)(\)\s*=>)/g, (match, open, params, suffix) => {
                return open + colorParams(params) + suffix;
            });

            // Single-parameter arrow functions
            code = code.replace(/\b([a-zA-Z_$][\w$]*)(\s*=>)/g, (match, param, arrowPart) => {
                if (reservedKeywords.has(param) || param.startsWith(PLACEHOLDER_PREFIX)) {
                    return match;
                }
                return `<span style="color:${palette.param};">${param}</span>${arrowPart}`;
            });

            // Function call / method names
            code = code.replace(/\b([a-zA-Z_$][\w$]*)\s*(?=\()/g, (match, name) => {
                if (reservedKeywords.has(name) || name.startsWith(PLACEHOLDER_PREFIX)) {
                    return match;
                }
                let a = []
                return `<span style="color:${palette.functionCall};">${name}</span>`;
            });

            // Boolean literals
            code = code.replace(/\b(true|false)\b/g, `<span style="color:${palette.boolean};">$1</span>`);

            // Numbers
            code = code.replace(/\b\d+(?:\.\d+)?\b/g, match => `<span style="color:${palette.number};">${match}</span>`);

            // Structure keywords coloring
            const structureRegex = new RegExp(`\\b(${Array.from(structureKeywords).join('|')})\\b`, 'g');
            code = code.replace(structureRegex, `<span style="color:${palette.structure};">$1</span>`);

            // Declaration keywords coloring
            const declarationRegex = new RegExp(`\\b(${Array.from(declarationKeywords).join('|')})\\b`, 'g');
            code = code.replace(declarationRegex, `<span style="color:${palette.declaration};">$1</span>`);

            // Bracket coloring (safe): stash bracket spans so they are restored after escaping
            // Use gold color #ffd700 for square brackets per user request
            code = code.replace(/\[/g, () => stash(`<span style="color:#ffd700;">[</span>`));
            code = code.replace(/\]/g, () => stash(`<span style="color:#ffd700;">]</span>`));

            // Variable names (identifiers not already styled)
            const protectedSpans = protectSpans(code);
            code = protectedSpans.text.replace(/\b([a-zA-Z_$][\w$]*)\b/g, (match, ident, offset, str) => {
                if (ident.startsWith(PLACEHOLDER_PREFIX)) {
                    return ident;
                }
                if (reservedKeywords.has(ident) || ident === 'true' || ident === 'false') {
                    return ident;
                }
                const prevChar = offset > 0 ? str[offset - 1] : '';
                if (prevChar === '&') {
                    // Avoid breaking HTML entities like &lt;
                    return ident;
                }
                return `<span style="color:${palette.variable};">${ident}</span>`;
            });
            code = restoreFromIndex(code, protectedSpans.startIndex);

            const finalProtection = protectSpans(code);
            code = escapeHtml(finalProtection.text);
            code = restoreFromIndex(code, finalProtection.startIndex);

            // Restore preserved segments (strings, comments, etc.)
            code = restoreFromIndex(code, 0);

            htmlSanitizer.innerHTML = code;
            const sanitized = htmlSanitizer.innerHTML;
            htmlSanitizer.innerHTML = '';
            return sanitized;
        }

        function getThemeStyles() {
            if (darkModeToggle.checked) {
                return {
                    container: 'margin: 20px 0; border-radius: 10px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,.22); border: 1px solid rgba(255,255,255,.08); background: #1e1e1e; color: #d4d4d4;',
                    header: 'display: flex; align-items: center; justify-content: flex-start; background: #1f2430; padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,.08); font-family: ui-sans-serif,system-ui,-apple-system,\'Segoe UI\',Roboto,Inter,Arial,sans-serif; font-size: 13px; color: #c7c7c7;',
                    codeBackground: '#1e1e1e',
                    imageBackground: '#1b1e27',
                    dividerBorder: '1px solid rgba(255,255,255,.08)',
                    consoleBackground: '#0d1f0d',
                    consoleText: '#23db35',
                    consoleBorder: '1px solid rgba(255,255,255,.08)',
                    syntax: {
                        string: '#ce9178',
                        comment: '#6a9955',
                        functionDeclaration: '#dcdcaa',
                        functionCall: '#dcdcaa',
                        param: '#9cdcfe',
                        boolean: '#4d9cd6',
                        number: '#a4caa5',
                        variable: '#9bdbfd',
                        structure: '#c586c0',
                        declaration: '#569cd6'
                    }
                };
            }
            return {
                container: 'margin: 20px 0; border-radius: 10px; overflow: hidden; box-shadow: 0 8px 18px rgba(0,0,0,.12); border: 1px solid rgba(0,0,0,.16); background: #ffffff; color: #1f1f1f;',
                header: 'display: flex; align-items: center; justify-content: flex-start; background: #f2f2f2; padding: 8px 12px; border-bottom: 1px solid rgba(0,0,0,.12); font-family: ui-sans-serif,system-ui,-apple-system,\'Segoe UI\',Roboto,Inter,Arial,sans-serif; font-size: 13px; color: #333;',
                codeBackground: '#ffffff',
                imageBackground: '#f8f8f8',
                dividerBorder: '1px solid rgba(0,0,0,.08)',
                consoleBackground: '#f5f5f5',
                consoleText: '#0a6c0a',
                consoleBorder: '1px solid rgba(0,0,0,.12)',
                syntax: {
                    string: '#a31515',
                    comment: '#008000',
                    functionDeclaration: '#795E26',
                    functionCall: '#795E26',
                    param: '#0072c6',
                    boolean: '#0000ff',
                    number: '#098658',
                    variable: '#001080',
                    structure: '#af00db',
                    declaration: '#0000ff'
                }
            };
        }

        function applyConsoleTheme() {
            if (!consoleOutput) {
                return;
            }
            const theme = getThemeStyles();
            consoleOutput.style.background = theme.consoleBackground;
            consoleOutput.style.color = theme.consoleText;
            consoleOutput.style.borderTop = theme.consoleBorder;
        }

        function applyCopyButtonTheme() {
            if (!copyIcon) {
                return;
            }
            const iconImg = copyIcon.querySelector('img');
            copyIcon.style.removeProperty('--copy-icon-bg');
            copyIcon.style.removeProperty('--copy-icon-hover-bg');
            copyIcon.style.removeProperty('--copy-icon-border');
            if (iconImg) {
                iconImg.style.filter = 'none';
            }
        }

        // Apply global UI theme to editor, preview pane, and toolbar
        function applyGlobalUiTheme() {
            if (darkModeToggle && darkModeToggle.checked) {
                document.body.classList.add('app-dark');
            } else {
                document.body.classList.remove('app-dark');
            }
        }

        function copyTextFallback(text) {
            return new Promise((resolve, reject) => {
                const previousActive = document.activeElement;
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textarea);
                    if (previousActive && typeof previousActive.focus === 'function') {
                        previousActive.focus();
                    }
                    if (successful) {
                        resolve();
                    } else {
                        reject(new Error('Copy command unsuccessful'));
                    }
                } catch (err) {
                    document.body.removeChild(textarea);
                    if (previousActive && typeof previousActive.focus === 'function') {
                        previousActive.focus();
                    }
                    reject(err);
                }
            });
        }

        function copyPreviewHtml() {
            const html = normalizePreviewHtml(preview.innerHTML);
            if (!html) {
                return Promise.resolve();
            }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(html).catch(() => copyTextFallback(html));
            }
            return copyTextFallback(html);
        }

        function normalizePreviewHtml(html) {
            if (!html) {
                return '';
            }
            return html
                .replace(/\s*<\/li>\s*(?=<li)/g, '</li>\n')
                .replace(/\s*<\/div>\s*(?=<div)/g, '</div>\n')
                .replace(/\s*<\/ol>\s*(?=<\/div>)/g, '</ol>\n');
        }

        function formatToHtml(code) {
            // Format JS code into HTML like the example
            const theme = getThemeStyles();
            let lines = code.split(/\r?\n/);
            while (lines.length > 1 && lines[lines.length - 1] === '') {
                lines.pop();
            }
            if (lines.length === 0) {
                lines = [''];
            }

            const card = document.createElement('div');
            card.dataset.role = 'code-card';
            card.style.cssText = theme.container;

            const filenameBar = document.createElement('div');
            filenameBar.dataset.role = 'filename';
            filenameBar.style.cssText = theme.header;
            filenameBar.style.display = filenameToggle.checked ? 'flex' : 'none';
            const filenameLabel = document.createElement('span');
            filenameLabel.dataset.role = 'filename-label';
            filenameLabel.style.opacity = '.9';
            filenameLabel.style.cursor = 'text';
            filenameLabel.setAttribute('contenteditable', 'true');
            filenameLabel.setAttribute('tabindex', '0');
            filenameLabel.textContent = 'filename.js';
            // prevent the label itself from creating HTML; sanitize on blur
            filenameLabel.addEventListener('blur', (ev) => {
                // collapse whitespace/newlines and keep plain text
                filenameLabel.textContent = (filenameLabel.textContent || '').replace(/\s+/g, ' ').trim();
            });
            // Attach selection handlers (mousedown/touch/dblclick/focus)
            attachFilenameSelectionHandlers(filenameLabel);
            filenameBar.appendChild(filenameLabel);
            card.appendChild(filenameBar);

            const codeRegion = document.createElement('div');
            codeRegion.dataset.role = 'code-row';
            codeRegion.style.cssText = `font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; font-size: 14px; line-height: 1.55; background: ${theme.codeBackground}; display: flex;`;
            card.appendChild(codeRegion);

            const codeColumn = document.createElement('div');
            codeColumn.dataset.role = 'code-column';
            codeColumn.style.cssText = 'flex: 1; min-width: 0;';
            codeRegion.appendChild(codeColumn);

            const lineList = document.createElement('ol');
            lineList.dataset.role = 'code-lines';
            lineList.style.cssText = `margin: 0; padding: 12px 16px 12px 48px; list-style: decimal; background: ${theme.codeBackground};`;
            codeColumn.appendChild(lineList);

            for (let line of lines) {
                const li = document.createElement('li');
                li.style.cssText = 'white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere;';
                li.innerHTML = highlightJS(line, theme.syntax);
                lineList.appendChild(li);
            }

            const imagePanel = document.createElement('div');
            imagePanel.dataset.role = 'image';
            imagePanel.style.cssText = `width: 45%; max-width: 480px; border-left: ${theme.dividerBorder}; background: ${theme.imageBackground}; display: ${imgPreview.checked ? 'flex' : 'none'}; align-items: center; justify-content: center; padding: 12px;`;
            imagePanel.innerHTML = '<div><div style="font-size: 12px; letter-spacing: .3px; margin-bottom: 6px; opacity: .9;">IMAGE</div></div>';
            codeRegion.appendChild(imagePanel);

            const consolePanel = document.createElement('div');
            consolePanel.dataset.role = 'console';
            consolePanel.style.cssText = `background: ${theme.consoleBackground}; padding: 10px 14px; border-top: ${theme.consoleBorder}; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; font-size: 13px; line-height: 1.5; color: ${theme.consoleText}; display: ${consoleToggle.checked ? 'block' : 'none'};`;
            consolePanel.innerHTML = '<div>[LOG]:</div><div>[ERROR]:</div>';
            card.appendChild(consolePanel);

            return card;
        }

        function getPreviewCard() {
            return preview.querySelector('[data-role="code-card"]');
        }

        // Ensure filename selection handlers are attached (idempotent)
        function attachFilenameSelectionHandlers(filenameLabel) {
            if (!filenameLabel || filenameLabel.dataset.selectHandlersAttached === '1') return;
            const selectFilename = (ev) => {
                try { ev.preventDefault(); } catch (e) {}
                filenameLabel.focus();
                const range = document.createRange();
                range.selectNodeContents(filenameLabel);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            };
            filenameLabel.addEventListener('mousedown', selectFilename);
            filenameLabel.addEventListener('touchstart', selectFilename, { passive: false });
            filenameLabel.addEventListener('dblclick', selectFilename);
            // Also select on focus for keyboard users
            filenameLabel.addEventListener('focus', (ev) => {
                const range = document.createRange();
                range.selectNodeContents(filenameLabel);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            });
            filenameLabel.dataset.selectHandlersAttached = '1';
        }

        function applyToggleVisibility() {
            const card = getPreviewCard();
            if (!card) {
                return false;
            }
            const filenameBar = card.querySelector('[data-role="filename"]');
            if (filenameBar) {
                filenameBar.style.display = filenameToggle.checked ? 'flex' : 'none';
            }
            const imagePanel = card.querySelector('[data-role="image"]');
            if (imagePanel) {
                imagePanel.style.display = imgPreview.checked ? 'flex' : 'none';
            }
            const consolePanel = card.querySelector('[data-role="console"]');
            if (consolePanel) {
                consolePanel.style.display = consoleToggle.checked ? 'block' : 'none';
            }
            return true;
        }

        function applyThemeToPreview() {
            const card = getPreviewCard();
            if (!card) {
                return false;
            }
            const theme = getThemeStyles();

            card.style.cssText = theme.container;

            const filenameBar = card.querySelector('[data-role="filename"]');
            if (filenameBar) {
                filenameBar.style.cssText = theme.header;
                filenameBar.style.display = filenameToggle.checked ? 'flex' : 'none';
            }

            const codeRegion = card.querySelector('[data-role="code-row"]');
            if (codeRegion) {
                codeRegion.style.cssText = `font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; font-size: 14px; line-height: 1.55; background: ${theme.codeBackground}; display: flex;`;
            }

            const lineList = card.querySelector('[data-role="code-lines"]');
            if (lineList) {
                lineList.style.cssText = `margin: 0; padding: 12px 16px 12px 48px; list-style: decimal; background: ${theme.codeBackground};`;
                const lines = Array.from(lineList.querySelectorAll('li'));
                lines.forEach(li => {
                    const text = li.textContent;
                    li.innerHTML = highlightJS(text, theme.syntax);
                });
            }

            const imagePanel = card.querySelector('[data-role="image"]');
            if (imagePanel) {
                imagePanel.style.cssText = `width: 45%; max-width: 480px; border-left: ${theme.dividerBorder}; background: ${theme.imageBackground}; display: ${imgPreview.checked ? 'flex' : 'none'}; align-items: center; justify-content: center; padding: 12px;`;
            }

            const consolePanel = card.querySelector('[data-role="console"]');
            if (consolePanel) {
                consolePanel.style.cssText = `background: ${theme.consoleBackground}; padding: 10px 14px; border-top: ${theme.consoleBorder}; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; font-size: 13px; line-height: 1.5; color: ${theme.consoleText}; display: ${consoleToggle.checked ? 'block' : 'none'};`;
            }

            applyToggleVisibility();
            applyCopyButtonTheme();
            return true;
        }

        function isPlaceholderActive() {
            return editor.classList.contains('placeholder-text');
        }

        function ensurePlaceholder() {
            if (!editor.textContent.trim()) {
                editor.textContent = '// Paste your code here';
                editor.classList.add('placeholder-text');
            }
        }

        function updatePreview() {
            let content = editor.innerText || editor.textContent;
            if (isPlaceholderActive()) {
                const card = formatToHtml('');
                preview.replaceChildren(card);
                applyToggleVisibility();
                applyCopyButtonTheme();
                return;
            }
            // If it looks like JS code, format it
            if (/function|let|const|var|=>|return|class|for|while|if|else|switch|case|break|continue|try|catch|finally/.test(content)) {
                const existingCard = getPreviewCard();
                const theme = getThemeStyles();
                // build lines array similar to formatToHtml so we can update in-place
                let lines = content.split(/\r?\n/);
                while (lines.length > 1 && lines[lines.length - 1] === '') {
                    lines.pop();
                }
                if (lines.length === 0) lines = [''];

                if (existingCard) {
                    // Preserve mutable parts of the card so we don't clobber user edits
                    const filenameEl = existingCard.querySelector('[data-role="filename-label"]');
                    const savedFilename = filenameEl ? filenameEl.textContent : null;
                    const imagePanel = existingCard.querySelector('[data-role="image"]');
                    const savedImageInner = imagePanel ? imagePanel.innerHTML : null;
                    const savedImageDisplay = imagePanel ? imagePanel.style.display : null;
                    const consolePanel = existingCard.querySelector('[data-role="console"]');
                    const savedConsoleInner = consolePanel ? consolePanel.innerHTML : null;

                    // Update code lines in-place to avoid replacing the whole card
                    const lineList = existingCard.querySelector('[data-role="code-lines"]');
                    if (lineList) {
                        lineList.innerHTML = '';
                        for (let line of lines) {
                            const li = document.createElement('li');
                            li.style.cssText = 'white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere;';
                            li.innerHTML = highlightJS(line, theme.syntax);
                            lineList.appendChild(li);
                        }
                    } else {
                        // If structure changed unexpectedly, recreate the card as a fallback
                        const card = formatToHtml(content);
                        preview.replaceChildren(card);
                        applyToggleVisibility();
                        applyCopyButtonTheme();
                        return;
                    }

                    // Update styling for code region and container in case theme changed
                    const codeRegion = existingCard.querySelector('[data-role="code-row"]');
                    if (codeRegion) {
                        codeRegion.style.cssText = `font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; font-size: 14px; line-height: 1.55; background: ${theme.codeBackground}; display: flex;`;
                    }
                    existingCard.style.cssText = theme.container;

                    // Restore preserved filename/console/image content & visibility
                    if (savedFilename !== null) {
                        const filenameLabel = existingCard.querySelector('[data-role="filename-label"]');
                        if (filenameLabel) {
                            filenameLabel.textContent = savedFilename;
                            attachFilenameSelectionHandlers(filenameLabel);
                        }
                    }
                    if (savedConsoleInner !== null) {
                        const consoleEl = existingCard.querySelector('[data-role="console"]');
                        if (consoleEl) consoleEl.innerHTML = savedConsoleInner;
                    }
                    if (imagePanel) {
                        // respect the current checkbox state, but keep inner content if user modified it
                        imagePanel.style.display = imgPreview.checked ? 'flex' : 'none';
                        if (savedImageInner) imagePanel.innerHTML = savedImageInner;
                        imagePanel.style.cssText = `width: 45%; max-width: 480px; border-left: ${theme.dividerBorder}; background: ${theme.imageBackground}; display: ${imgPreview.checked ? 'flex' : 'none'}; align-items: center; justify-content: center; padding: 12px;`;
                    }

                    applyToggleVisibility();
                    applyCopyButtonTheme();
                } else {
                    const card = formatToHtml(content);
                    preview.replaceChildren(card);
                    applyToggleVisibility();
                    applyCopyButtonTheme();
                }
            } else {
                const existingCard = getPreviewCard();
                const theme = getThemeStyles();
                let lines = content.split(/\r?\n/);
                while (lines.length > 1 && lines[lines.length - 1] === '') lines.pop();
                if (lines.length === 0) lines = [''];

                if (existingCard) {
                    const filenameEl = existingCard.querySelector('[data-role="filename-label"]');
                    const savedFilename = filenameEl ? filenameEl.textContent : null;
                    const imagePanel = existingCard.querySelector('[data-role="image"]');
                    const savedImageInner = imagePanel ? imagePanel.innerHTML : null;
                    const consolePanel = existingCard.querySelector('[data-role="console"]');
                    const savedConsoleInner = consolePanel ? consolePanel.innerHTML : null;

                    const lineList = existingCard.querySelector('[data-role="code-lines"]');
                    if (lineList) {
                        lineList.innerHTML = '';
                        for (let line of lines) {
                            const li = document.createElement('li');
                            li.style.cssText = 'white-space: pre-wrap; word-break: break-word; overflow-wrap: anywhere;';
                            li.innerHTML = highlightJS(line, theme.syntax);
                            lineList.appendChild(li);
                        }
                    } else {
                        const card = formatToHtml(content);
                        preview.replaceChildren(card);
                        applyToggleVisibility();
                        applyCopyButtonTheme();
                        return;
                    }

                    const codeRegion = existingCard.querySelector('[data-role="code-row"]');
                    if (codeRegion) {
                        codeRegion.style.cssText = `font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; font-size: 14px; line-height: 1.55; background: ${theme.codeBackground}; display: flex;`;
                    }
                    existingCard.style.cssText = theme.container;

                    if (savedFilename !== null) {
                        const filenameLabel = existingCard.querySelector('[data-role="filename-label"]');
                        if (filenameLabel) {
                            filenameLabel.textContent = savedFilename;
                            attachFilenameSelectionHandlers(filenameLabel);
                        }
                    }
                    if (savedConsoleInner !== null) {
                        const consoleEl = existingCard.querySelector('[data-role="console"]');
                        if (consoleEl) consoleEl.innerHTML = savedConsoleInner;
                    }
                    if (imagePanel) {
                        imagePanel.style.display = imgPreview.checked ? 'flex' : 'none';
                        if (savedImageInner) imagePanel.innerHTML = savedImageInner;
                        imagePanel.style.cssText = `width: 45%; max-width: 480px; border-left: ${theme.dividerBorder}; background: ${theme.imageBackground}; display: ${imgPreview.checked ? 'flex' : 'none'}; align-items: center; justify-content: center; padding: 12px;`;
                    }

                    applyToggleVisibility();
                    applyCopyButtonTheme();
                } else {
                    const card = formatToHtml(content);
                    preview.replaceChildren(card);
                    applyToggleVisibility();
                    applyCopyButtonTheme();
                }
            }
        }

        editor.addEventListener('focus', () => {
            if (isPlaceholderActive()) {
                editor.textContent = '';
                editor.classList.remove('placeholder-text');
                updatePreview();
            }
        });

        editor.addEventListener('blur', () => {
            if (!editor.textContent.trim()) {
                ensurePlaceholder();
                updatePreview();
            }
        });

        editor.addEventListener('input', () => {
            editor.classList.remove('placeholder-text');
            updatePreview();
        });
        const handleStructureToggle = () => {
            if (!applyToggleVisibility()) {
                updatePreview();
            }
        };

        imgPreview.addEventListener('change', handleStructureToggle);
        filenameToggle.addEventListener('change', handleStructureToggle);
        consoleToggle.addEventListener('change', () => {
            if (!applyToggleVisibility()) {
                updatePreview();
            }
            if (!consoleOutput) {
                return;
            }
            if (consoleToggle.checked) {
                consoleOutput.style.display = 'block';
                applyConsoleTheme();
            } else {
                consoleOutput.style.display = 'none';
            }
        });
        darkModeToggle.addEventListener('change', () => {
            applyGlobalUiTheme();
            applyConsoleTheme();
            applyCopyButtonTheme();
            if (!applyThemeToPreview()) {
                updatePreview();
            }
        });
        formatBtn.addEventListener('click', () => {
            updatePreview();
        });
        if (copyIcon) {
            const triggerCopy = () => {
                copyPreviewHtml().then(() => {
                    copyIcon.dataset.copied = 'true';
                    setTimeout(() => {
                        delete copyIcon.dataset.copied;
                    }, 1300);
                }).catch(() => {});
            };
            copyIcon.addEventListener('click', triggerCopy);
            copyIcon.addEventListener('keydown', (event) => {
                if (event.key === 'Enter' || event.key === ' ') {
                    event.preventDefault();
                    triggerCopy();
                }
            });
        }

        // Filename selection now handled by direct mousedown/touchstart listeners
        // attached to the filename label when the preview card is created.

        function syncBuyMeSize() {
            if (!buyMeImg || !formatBtn) return;
            const btnRect = formatBtn.getBoundingClientRect();
            const target = Math.max(20, Math.round(btnRect.height));
            buyMeImg.style.height = target + 'px';
            buyMeImg.style.width = 'auto';
        }

        // Ensure preview/editor are scrollable on mobile and reachable to the end
        function applyResponsiveHeights() {
            const w = window.innerWidth;
            if (!layoutContainer) return;

            const toolbarEl = document.querySelector('.toolbar');
            const toolbarH = toolbarEl ? Math.round(toolbarEl.getBoundingClientRect().height) : 80;
            const available = Math.max(200, window.innerHeight - toolbarH);
            // Always set the layout container height to viewport minus toolbar so panes can fill
            layoutContainer.style.height = available + 'px';

            if (w <= 900) {
                // Give editor ~40% and preview ~60% of available height on mobile
                const editorH = Math.max(120, Math.round(available * 0.42));
                const previewH = Math.max(120, available - editorH);

                editorPane.style.flex = 'none';
                previewPane.style.flex = 'none';
                editorPane.style.height = editorH + 'px';
                previewPane.style.height = previewH + 'px';
                editorPane.style.overflow = 'auto';
                previewPane.style.overflow = 'auto';
            } else {
                // Desktop: keep horizontal split, let panes fill container height
                editorPane.style.flex = '0 0 50%';
                editorPane.style.height = '100%';
                previewPane.style.flex = '1 1 auto';
                previewPane.style.height = '100%';
                editorPane.style.overflow = 'auto';
                previewPane.style.overflow = 'auto';
            }
        }

        window.addEventListener('resize', syncBuyMeSize);
        window.addEventListener('resize', applyResponsiveHeights);
        window.addEventListener('orientationchange', applyResponsiveHeights);

        ensurePlaceholder();
        preview.replaceChildren(formatToHtml(''));
        applyGlobalUiTheme();
        applyConsoleTheme();
        applyCopyButtonTheme();
        syncBuyMeSize();
        // apply responsive heights after initial render
        applyResponsiveHeights();
    </script>
</body>
</html>